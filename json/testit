#!/bin/bash

gcc -fsanitize=undefined -O0 -ggdb -o json -I../meta/src  -DJSON_CHECK -Wall -Wextra -pedantic -std=c99 json.c -lmeta
if test $? -ne 0; then
    exit 1
fi

gcc -DNDEBUG -O3 -march=native -mtune=native -o fastjson -I../meta/src  -DJSON_CHECK -Wall -Wextra -pedantic -std=c99 json.c -lmeta
if test $? -ne 0; then
    exit 1
fi

# These must pass
./json test/pass1.json || exit 1 # 
./json test/pass2.json || exit 1 # 
./json test/pass3.json || exit 1 #

./json test/fail1.json && exit 1 # OK, fails as expected
./json test/fail2.json && exit 2 # OK, fails as expected
./json test/fail3.json && exit 3 # OK, fails as expected

./json test/fail4.json && exit 4 # OK, extra comma
./json test/fail5.json && exit 5 # OK, double extra comma
./json test/fail6.json && exit 6 # OK, Missing value (i.e., list starts with a comma)
./json test/fail7.json && exit 7 # OK, Comma after the close (as in [],)
./json test/fail8.json && exit 8 # OK, extra close ([]])
./json test/fail9.json && exit 9 # OK, Extra comma (after value and before })

./json test/fail10.json && exit 10 # OK, extra value after close
./json test/fail11.json && exit 11 # OK, fails as expected
./json test/fail12.json && exit 12 # OK, fails as expected

./json test/fail13.json && exit 13 # OK, but not gracefully. Numbers cannot have leading zeroes

./json test/fail14.json && exit 1 # OK
./json test/fail15.json && exit 1 # OK. Illegal backslash escape (\x15)
./json test/fail16.json && exit 1 # OK
./json test/fail17.json && exit 1 # OK. Illegal backslash escape (\017)
./json test/fail18.json && exit 18  # OK. Too deep (as in [[[[[[[[[[["too deep"]]]]]]]]

./json test/fail19.json && exit 1 # OK
./json test/fail20.json && exit 1 # OK
./json test/fail21.json && exit 1 # OK
./json test/fail22.json && exit 1 # OK
./json test/fail23.json && exit 1 # OK
./json test/fail24.json && exit 1 # OK

./json test/fail25.json && exit 1 # OK

./json test/fail26.json && exit 26 # OK. TAB character in string

./json test/fail27.json && exit 1 # OK
./json test/fail28.json && exit 1 # OK

./json test/fail29.json && exit 1 # OK
./json test/fail30.json && exit 1 # OK
./json test/fail31.json && exit 1 # OK
./json test/fail32.json && exit 1 # OK
./json test/fail33.json && exit 1 # OK
